---
# User setting
- name: Create prometheus group
  ansible.builtin.group:
    name: prometheus
    system: true
    state: present
  become: true

- name: Create prometheus user
  ansible.builtin.user:
    name: prometheus
    comment: prometheus
    group: prometheus
    shell: /sbin/nologin
    system: true
    create_home: false
  become: true

# Directory setting
- name: Create prometheus config directory
  ansible.builtin.file:
    path: "{{ prometheus_config_path }}"
    state: directory
    mode: "0755"
    owner: prometheus
    group: prometheus
  become: true

- name: Create prometheus sd_file directory
  ansible.builtin.file:
    path: "{{ prometheus_sd_file_path }}"
    state: directory
    mode: "0755"
    owner: prometheus
    group: prometheus
  become: true

# Configurations
- name: Create file SD for exporter
  ansible.builtin.template:
    src: sd_file.yml.j2
    dest: "{{ prometheus_sd_file_path }}/sd_file.yml"
    mode: "0644"
    owner: prometheus
    group: prometheus
  become: true
  vars:
    netbox_services: "{{ query('netbox.netbox.nb_lookup',
                        'services',
                        api_endpoint=netbox_url,
                        token=netbox_token) }}"
